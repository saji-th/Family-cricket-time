<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Family Group eke ayata Cricket</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        #debug-log {
            width: 100%;
            max-width: 600px;
            margin-top: 10px;
            padding: 10px;
            background: #222;
            color: #ccc;
            font-family: monospace;
            font-size: 0.7rem;
            border-radius: 8px;
            display: none;
            word-break: break-all;
            text-align: left;
        }

        .admin-controls {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        .url-input {
            width: 70%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #111;
            color: #fff;
            margin-right: 5px;
        }

        .btn-update {
            padding: 8px 15px;
            background: #ff4757;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Family Group eke ayata Cricket</h1>
            <p>Live Stream Experience</p>
        </header>

        <main class="player-container">
            <div class="video-wrapper" id="video-container">
                <!-- Native HTML5 Video Player with Default Controls -->
                <video id="video" controls autoplay playsinline muted preload="metadata"></video>

                <!-- Connection Quality Indicator -->
                <div class="connection-indicator" id="connection-indicator">
                    <span id="connection-status">●</span>
                    <span id="connection-text">Checking...</span>
                </div>

                <!-- Quality Selector Overlay -->
                <div class="quality-control">
                    <label>Quality:</label>
                    <select id="quality-select">
                        <option value="-1">Auto</option>
                    </select>
                </div>
            </div>

            <div class="message-box">
                <p>රංජිත් රත්නසිරිගේ අපල දුරු වේවා..!!</p>
            </div>
            <p class="stream-instruction">(If Stream stops, Enable Unblocker or Update Link)</p>

            <div class="controls">
                <p id="status" class="status-message">Loading Stream...</p>

                <!-- New Unblocker Toggle -->
                <div class="unblocker-control"
                    style="margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <label class="switch">
                        <input type="checkbox" id="proxy-toggle">
                        <span class="slider round"></span>
                    </label>
                    <span style="color: #ffcccc; font-weight: bold;">Enable Mobile Unblocker</span>
                </div>

                <div class="vpn-suggestion" style="margin-top: 10px;">
                    <a href="https://1.1.1.1/" target="_blank" class="btn-vpn"
                        style="text-decoration: none; color: #aaa; font-size: 0.8rem; border-bottom: 1px dotted #aaa;">
                        Still blocked? Get 1.1.1.1 App
                    </a>
                </div>

                <div id="debug-log"></div>
            </div>

            <!-- Admin Toggle Button -->
            <button class="admin-toggle-btn"
                onclick="document.getElementById('admin-panel').style.display = document.getElementById('admin-panel').style.display === 'none' ? 'block' : 'none'">
                Update Stream Link (Admin)
            </button>

            <!-- Admin Area (Hidden by default) -->
            <div id="admin-panel" class="admin-controls" style="display: none;">
                <p style="color: #888; margin-bottom: 10px; font-size: 0.9rem;">Change Stream Link:</p>
                <input type="text" id="stream-url" class="url-input" placeholder="Paste .m3u8 link here...">
                <button onclick="updateStream()" class="btn-update">Play</button>
            </div>
        </main>

        <footer>
            <p>&copy; 2026 Live Stream. Premium Experience.</p>
        </footer>
    </div>

    <script>
        var video = document.getElementById('video');
        var qualitySelect = document.getElementById('quality-select');
        var statusText = document.getElementById('status');
        var debugLog = document.getElementById('debug-log');
        var proxyToggle = document.getElementById('proxy-toggle');
        var urlInput = document.getElementById('stream-url');
        var connectionIndicator = document.getElementById('connection-indicator');
        var connectionStatus = document.getElementById('connection-status');
        var connectionText = document.getElementById('connection-text');

        // Default Link
        var defaultUrl = 'https://mut001.myluck1.top:8088/live/webcricn04/playlist.m3u8?vidictid=204966096525&id=114607&pk=3ef738dd90c7c0b44c4ca785f01c42dd3e4ea28aabe1fd655dcc0306b3bd32f87d2052fbb9f7afe9054dcc7a5485c9edb693e01479cd2799bc0f6cfa25f063bd';

        var videoSrc = localStorage.getItem('savedVideoSrc') || defaultUrl;
        urlInput.value = videoSrc;

        var useProxy = localStorage.getItem('useProxy') === 'true';
        proxyToggle.checked = useProxy;

        var hls;
        var connectionQuality = 'good'; // good, medium, poor
        var bufferingCount = 0;
        var lastBufferTime = 0;

        function logError(msg) {
            debugLog.style.display = 'block';
            debugLog.innerText += "\n> " + msg;
        }

        // Connection Quality Monitor
        function updateConnectionQuality(quality) {
            connectionQuality = quality;

            if (quality === 'good') {
                connectionStatus.style.color = '#4ade80';
                connectionText.innerText = 'Good Connection';
            } else if (quality === 'medium') {
                connectionStatus.style.color = '#fbbf24';
                connectionText.innerText = 'Medium Connection';
            } else {
                connectionStatus.style.color = '#f87171';
                connectionText.innerText = 'Poor Connection';
            }
        }

        // Monitor buffering and adjust quality
        video.addEventListener('waiting', function () {
            bufferingCount++;
            var currentTime = Date.now();

            if (currentTime - lastBufferTime < 5000) {
                // Buffering too frequently
                if (hls && hls.currentLevel > 0) {
                    // Lower quality
                    hls.currentLevel = Math.max(0, hls.currentLevel - 1);
                    updateConnectionQuality('poor');
                    logError('Lowering quality due to buffering');
                }
            }

            lastBufferTime = currentTime;
            statusText.innerText = 'Buffering...';
        });

        video.addEventListener('playing', function () {
            statusText.innerText = proxyToggle.checked ? "LIVE (Unblocked)" : "LIVE (Direct)";

            // Reset buffering count after successful playback
            setTimeout(function () {
                if (bufferingCount < 3) {
                    updateConnectionQuality('good');
                } else if (bufferingCount < 6) {
                    updateConnectionQuality('medium');
                }
                bufferingCount = 0;
            }, 10000);
        });

        // Error handling with retry
        var retryCount = 0;
        var maxRetries = 3;

        video.addEventListener('error', function (e) {
            logError('Video error: ' + (e.message || 'Unknown error'));

            if (retryCount < maxRetries) {
                retryCount++;
                statusText.innerText = 'Connection issue. Retrying... (' + retryCount + '/' + maxRetries + ')';

                setTimeout(function () {
                    loadStream(videoSrc);
                }, 2000 * retryCount); // Exponential backoff
            } else {
                statusText.innerText = 'Failed to load stream. Try enabling Unblocker.';
                updateConnectionQuality('poor');
            }
        });

        function loadStream(url) {
            if (hls) {
                hls.destroy();
            }

            var finalUrl = url;
            if (proxyToggle.checked) {
                statusText.innerText = "Connecting via Unblocker...";
                finalUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
            } else {
                statusText.innerText = "Connecting Direct...";
            }

            logError("Loading...");
            updateConnectionQuality('medium');

            if (Hls.isSupported()) {
                var config = {
                    startLevel: -1,             // AUTO Quality (Starts low, upgrades if good)
                    autoLevelEnabled: true,     // Enable Auto-Switching
                    maxBufferLength: 20,        // Reduced for mobile
                    maxMaxBufferLength: 40,     // Reduced for mobile
                    liveSyncDurationCount: 3,
                    enableWorker: true,         // Use web worker for better performance
                    lowLatencyMode: false,      // Disable for better stability
                    backBufferLength: 10,       // Keep some back buffer

                    // Mobile-specific optimizations
                    abrEwmaDefaultEstimate: 500000, // Start with lower estimate
                    abrBandWidthFactor: 0.95,       // More conservative bandwidth usage
                    abrBandWidthUpFactor: 0.7,      // Slower quality upgrades
                };

                hls = new Hls(config);
                hls.loadSource(finalUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play().catch(e => {
                        logError("Tap Play button to start");
                        statusText.innerText = "Ready - Tap Play";
                    });
                    statusText.innerText = proxyToggle.checked ? "LIVE (Unblocked)" : "LIVE (Direct)";
                    logError("Connected!");
                    updateConnectionQuality('good');
                    retryCount = 0; // Reset retry count on success

                    // Populate Quality
                    qualitySelect.innerHTML = '';

                    // Add Auto option first
                    var autoOpt = document.createElement('option');
                    autoOpt.value = -1;
                    autoOpt.text = "Auto (Recommended)";
                    autoOpt.selected = true;
                    qualitySelect.appendChild(autoOpt);

                    // Add quality levels
                    hls.levels.forEach(function (level, index) {
                        var option = document.createElement('option');
                        option.value = index;
                        var height = level.height || '?';
                        var label = height + 'p';
                        if (height >= 720) label += ' (HD)';
                        if (height >= 1080) label += ' ⭐';
                        option.text = label;
                        qualitySelect.appendChild(option);
                    });
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        logError("Error: " + data.type + " - " + (data.details || ''));

                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                logError("Network error - attempting recovery...");
                                updateConnectionQuality('poor');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                logError("Media error - attempting recovery...");
                                hls.recoverMediaError();
                                break;
                            default:
                                logError("Fatal error - destroying player");
                                hls.destroy();

                                // Try to reload after a delay
                                setTimeout(function () {
                                    if (retryCount < maxRetries) {
                                        retryCount++;
                                        loadStream(videoSrc);
                                    }
                                }, 3000);
                                break;
                        }
                    }
                });

                // Monitor level changes
                hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
                    var level = hls.levels[data.level];
                    if (level) {
                        logError('Quality: ' + (level.height || '?') + 'p');
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari, iOS)
                video.src = finalUrl;
                video.addEventListener('loadedmetadata', function () {
                    video.play().catch(e => {
                        logError("Tap Play to start");
                    });
                    statusText.innerText = "LIVE (Native)";
                    updateConnectionQuality('good');
                });
            } else {
                statusText.innerText = "Browser not supported";
                logError("HLS not supported in this browser");
            }
        }

        function updateStream() {
            var newUrl = urlInput.value.trim();
            if (newUrl) {
                videoSrc = newUrl;
                localStorage.setItem('savedVideoSrc', newUrl);
                retryCount = 0; // Reset retry count
                loadStream(videoSrc);
            }
        }

        proxyToggle.addEventListener('change', function () {
            localStorage.setItem('useProxy', this.checked);
            retryCount = 0; // Reset retry count
            loadStream(videoSrc);
        });

        // Init
        loadStream(videoSrc);

        qualitySelect.addEventListener('change', function () {
            if (hls) {
                if (this.value == -1) {
                    hls.currentLevel = -1; // Auto
                    logError('Quality set to Auto');
                } else {
                    hls.currentLevel = parseInt(this.value);
                    var level = hls.levels[this.value];
                    logError('Quality set to ' + (level.height || '?') + 'p');
                }
            }
        });

        // Mobile-specific: Prevent screen sleep during playback
        if ('wakeLock' in navigator) {
            var wakeLock = null;

            video.addEventListener('play', async function () {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    // Wake lock not available
                }
            });

            video.addEventListener('pause', function () {
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
            });
        }
    </script>
</body>

</html>
